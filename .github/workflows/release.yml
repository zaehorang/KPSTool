name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  pull-requests: write

jobs:
  build-and-release:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Get version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "version_number=${VERSION#v}" >> $GITHUB_OUTPUT

      - name: Build Universal Binary
        run: |
          # Build for both architectures
          swift build -c release --arch arm64
          swift build -c release --arch x86_64

          # Create Universal binary
          lipo -create \
            .build/arm64-apple-macosx/release/kps \
            .build/x86_64-apple-macosx/release/kps \
            -output kps

          # Verify Universal binary
          lipo -info kps
          file kps

      - name: Create Archive
        run: |
          tar -czf kps-${{ steps.version.outputs.version }}.tar.gz kps

      - name: Calculate SHA256
        id: sha
        run: |
          SHA256=$(shasum -a 256 kps-${{ steps.version.outputs.version }}.tar.gz | cut -d ' ' -f 1)
          echo "sha256=$SHA256" >> $GITHUB_OUTPUT
          echo "SHA256: $SHA256"

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            kps-${{ steps.version.outputs.version }}.tar.gz
          generate_release_notes: true
          body: |
            ## Installation

            ### Homebrew (Recommended)
            ```bash
            brew tap zaehorang/tap
            brew install kps
            ```

            ### Manual Installation
            Download the Universal binary (supports both Apple Silicon and Intel Macs) and extract it to your PATH.

            **SHA256 Checksum:**
            - Universal (arm64 + x86_64): `${{ steps.sha.outputs.sha256 }}`
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Checkout homebrew-tap
        uses: actions/checkout@v4
        with:
          repository: zaehorang/homebrew-tap
          path: homebrew-tap
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}

      - name: Update Formula
        run: |
          cd homebrew-tap

          # Update Formula/kps.rb (Universal binary - simple sed replacement)
          sed -i '' 's/version ".*"/version "${{ steps.version.outputs.version_number }}"/' Formula/kps.rb
          sed -i '' 's|url "https://github.com/zaehorang/KPSTool/releases/download/.*/kps-.*\.tar\.gz"|url "https://github.com/zaehorang/KPSTool/releases/download/${{ steps.version.outputs.version }}/kps-${{ steps.version.outputs.version }}.tar.gz"|' Formula/kps.rb
          sed -i '' 's/sha256 ".*"/sha256 "${{ steps.sha.outputs.sha256 }}"/' Formula/kps.rb

          # Show the changes
          git diff Formula/kps.rb

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          path: homebrew-tap
          branch: update-kps-${{ steps.version.outputs.version }}
          commit-message: "chore: update kps to ${{ steps.version.outputs.version }}"
          title: "chore: update kps to ${{ steps.version.outputs.version }}"
          body: |
            Auto-generated PR to update kps formula to ${{ steps.version.outputs.version }}

            **Release:** https://github.com/zaehorang/KPSTool/releases/tag/${{ steps.version.outputs.version }}

            **SHA256 Checksum:**
            - Universal (arm64 + x86_64): `${{ steps.sha.outputs.sha256 }}`

            Please review and merge to publish the new version to Homebrew.
          delete-branch: true
